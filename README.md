# Smart Car Control System

## 项目简介

这是一个基于 Infineon AURIX TC264 微控制器的智能车控制系统，使用 Seekfree 开源库开发。系统集成了图像处理、电机控制、舵机转向、PID 算法等多种功能，旨在实现智能车的自主循迹和控制。

## 项目特性

### 🚗 核心功能
- **图像处理与循迹**：支持 MT9V03X 摄像头图像采集，大津法二值化，边界检测，加权中线计算
- **电机控制**：双电机驱动，支持 PWM 调速，前进/后退控制
- **舵机转向**：PWM 控制舵机角度，实现车辆转向
- **PID 控制算法**：位置式 PID（舵机转向）和增量式 PID（电机速度）
- **状态机管理**：四种工作状态（图像调试、舵机调试、电机调试、运行模式）

### 📡 传感器集成
- **摄像头**：MT9V03X CMOS 摄像头 (188x120 分辨率)
- **陀螺仪**：ICM20602 六轴传感器，用于角度测量和零飘校正
- **编码器**：左右轮编码器，用于速度测量
- **按键与拨码开关**：4 个按键和 4 个拨码开关，用于参数调节和模式切换

### 🔧 系统架构
- **主控芯片**：Infineon AURIX TC264D
- **开发环境**：ADS v1.10.2
- **通信接口**：
  - UART1：摄像头配置串口
  - UART3：蓝牙串口
  - 无线 UART：数据传输
- **定时器**：CCU60 双通道 PIT 中断（10ms 周期）

## 项目结构

```
Smart_car/
├── code/                          # 用户代码
│   ├── buzzer.c/h               # 蜂鸣器控制
│   ├── data.c/h                 # 数据处理变量
│   ├── draw.c/h                 # 图像绘制函数
│   ├── image.c/h                # 图像处理核心算法
│   ├── init.c/h                 # 系统初始化
│   ├── motor.c/h                # 电机控制
│   ├── pid.c/h                  # PID 控制算法
│   ├── service.c/h              # 服务函数
│   ├── servo.c/h                # 舵机控制
│   └── state_machine.c/h        # 状态机管理
├── libraries/                   # Seekfree 开源库
│   ├── infineon_libraries/      # Infineon 官方库
│   └── zf_common/               # 逐飞通用库
│       ├── zf_common_clock.c/h    # 时钟管理
│       ├── zf_common_debug.c/h    # 调试功能
│       ├── zf_common_fifo.c/h     # FIFO 缓冲区
│       ├── zf_common_font.c/h     # 字体库
│       ├── zf_common_function.c/h # 通用函数
│       ├── zf_common_headfile.h   # 头文件汇总
│       ├── zf_common_interrupt.c/h# 中断管理
│       └── zf_common_typedef.h    # 类型定义
│   ├── zf_components/           # 逐飞组件库
│   └── zf_device/               # 逐飞设备驱动
├── user/                        # 用户主程序
│   ├── cpu0_main.c/h           # CPU0 主程序
│   ├── cpu1_main.c             # CPU1 主程序
│   ├── isr.c/h                 # 中断服务程序
│   └── isr_config.h            # 中断配置
├── Debug/                       # 编译输出文件
├── Lcf_Tasking_Tricore_Tc.lsl   # 链接器脚本
├── .cproject                    # Eclipse 项目文件
├── .project                     # 项目配置文件
└── README.md                    # 项目说明文档
```

## 功能模块详细说明

### 1. 图像处理模块 (image.c)
- **大津法二值化**：自动计算图像阈值，将灰度图像转换为二值图像
- **图像压缩**：将 188x120 图像压缩为 94x60，提高处理速度
- **噪声过滤**：中值滤波去除噪点
- **边界检测**：基于边缘检测算法寻找赛道左右边界
- **加权中线计算**：根据不同行权重计算赛道中线
- **丢线检测**：检测车辆是否偏离赛道
- **直线判断**：判断当前赛道是否为直线段

### 2. 电机控制模块 (motor.c)
- **PWM 驱动**：使用 ATOM0 四个通道实现 H 桥驱动
- **速度控制**：支持 -100 到 +100 的速度范围
- **左右轮独立控制**：左轮速度限制在 ±15，右轮 ±100

### 3. 舵机控制模块 (servo.c)
- **PWM 控制**：50Hz PWM 信号控制舵机角度
- **角度范围**：678 ± 63 占空比范围
- **居中校准**：678 为居中位置

### 4. PID 控制模块 (pid.c)
- **位置式 PID**：用于舵机转向控制
- **增量式 PID**：用于电机速度控制
- **参数调节**：
  - 舵机 PID：Kp=3.0, Ki=0, Kd=1.2
  - 左电机 PID：Kp=0.3, Ki=0, Kd=0
  - 右电机 PID：Kp=0.3, Ki=0, Kd=0

### 5. 状态机模块 (state_machine.c)
- **四种工作状态**：
  - `image_value`：图像调试模式，按键调节阈值
  - `servo_value`：舵机调试模式，按键调节角度
  - `motor_value`：电机调试模式，按键调节速度
  - `car_run_value`：运行模式，启动智能车控制

### 6. 中断服务模块 (isr.c)
- **PIT 中断**：
  - CCU60_CH0：10ms 编码器测速中断
  - CCU60_CH1：10ms 陀螺仪角度积分中断
- **外部中断**：摄像头 VSYNC、ToF 传感器等
- **DMA 中断**：摄像头数据传输完成
- **串口中断**：调试串口、无线模块、GNSS 等

### 7. 显示模块 (draw.c)
- **实时显示**：
  - 赛道边界线（左红、右蓝、中黄）
  - 编码器速度、PID 输出、误差值
  - 压缩图像显示

## 硬件连接

### 引脚分配
- **电机驱动**：
  - 左电机：P21_2(PWM), P21_3(PWM), P21_4(DIR), P21_5(DIR)
  - 右电机：ATOM0_CH0-3
- **舵机**：ATOM1_CH1_P33_9
- **编码器**：
  - 左轮：TIM2_ENCODER (P33_7, P33_6)
  - 右轮：TIM4_ENCODER (P02_8, P00_9)
- **串口**：
  - UART1：摄像头 (P02_2 TX, P02_3 RX)
  - UART3：蓝牙 (P15_7 TX, P20_3 RX)
- **按键**：KEY1-4 (默认配置)
- **拨码开关**：P11_12, P10_1, P10_2, P10_3
- **显示屏**：TFT180 接口

### 传感器连接
- **MT9V03X 摄像头**：标准接口
- **ICM20602 陀螺仪**：SPI 接口
- **TFT180 显示屏**：并行接口

## 软件配置

### 开发环境
- **IDE**：Infineon ADS v1.10.2
- **编译器**：Tasking VX-toolset for TriCore
- **目标芯片**：TC264D

### 依赖库
- **Seekfree TC264 开源库**：基于 Infineon iLLD 封装
- **Infineon iLLD**：低级驱动库
- **标准库**：C 标准库函数

## 使用说明

### 1. 编译与下载
1. 使用 ADS 打开项目
2. 配置编译选项
3. 编译生成 .elf 文件
4. 通过 JTAG 下载到 TC264 开发板

### 2. 参数调节
- **按键控制**：
  - KEY1：增加参数/启动运行
  - KEY2：减少参数/停止运行
  - KEY3：切换到下一状态
  - KEY4：切换到上一状态
- **状态切换**：
  - 图像模式：调节二值化阈值
  - 舵机模式：调节舵机角度
  - 电机模式：调节电机速度
  - 运行模式：启动智能车

### 3. 调试显示
TFT 显示屏实时显示：
- 压缩图像
- 左右编码器速度
- PID 输出值
- 误差计算结果

## 当前进度

### ✅ 已完成功能
- [x] 系统初始化框架
- [x] 电机 PWM 驱动
- [x] 舵机 PWM 控制
- [x] 编码器速度测量
- [x] ICM20602 陀螺仪数据读取
- [x] MT9V03X 摄像头图像采集
- [x] 大津法二值化算法
- [x] 图像压缩处理
- [x] 赛道边界检测
- [x] 加权中线计算
- [x] PID 控制算法实现
- [x] 状态机管理
- [x] 按键和拨码开关检测
- [x] TFT 显示功能
- [x] 中断服务框架
- [x] 串口通信配置

### 🚧 开发中功能
- [ ] 动态前瞻算法（代码已存在但被注释）
- [ ] 串级 PID 控制
- [ ] 路径规划算法
- [ ] 速度自适应控制
- [ ] 障碍物检测与避障

### 📋 待优化项目
- [ ] PID 参数自动调谐
- [ ] 图像处理算法优化
- [ ] 实时性能优化
- [ ] 电池电压检测
- [ ] 无线参数调节
- [ ] 数据记录与回放

## 技术参数

- **图像处理频率**：约 30 FPS (摄像头帧率)
- **控制周期**：10ms (PIT 中断)
- **速度测量精度**：编码器脉冲计数
- **角度测量精度**：陀螺仪积分 ±0.1°
- **PWM 频率**：20kHz (电机), 50Hz (舵机)

## 故障排除

### 常见问题
1. **摄像头无图像**：检查 UART1 连接和摄像头供电
2. **电机不转**：检查 PWM 引脚连接和 H 桥驱动
3. **舵机不响应**：检查 PWM 信号和舵机供电
4. **编码器无速度**：检查编码器线序和中断配置
5. **陀螺仪数据异常**：检查 SPI 通信和传感器校准

### 调试建议
- 使用 TFT 显示屏观察关键变量
- 通过调试串口输出中间结果
- 逐步调节 PID 参数
- 检查中断优先级配置

## 许可证

本项目基于 Seekfree TC264 开源库开发，遵循 GPL 3.0 许可证。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进项目。

## 联系方式

- **项目维护者**：ParacosmYy
- **技术支持**：逐飞科技 (https://seekfree.taobao.com/)

---

**最后更新**：2025年11月3日
